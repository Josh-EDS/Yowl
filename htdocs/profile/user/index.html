<!DOCTYPE html>
<html lang="en">

<head>
	<!-- Meta -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, minimal-ui, viewport-fit=cover">
	<meta name="theme-color" content="#2196f3">
	<meta name="author" content="Zephir" /> 
    <meta name="keywords" content="" /> 
    <meta name="robots" content="" /> 
	<meta name="description" content="Yowl - Your Online World Link"/>
	<meta property="og:title" content="Yowl - Your Online World Link" />
	<meta property="og:description" content="Yowl - Your Online World Link" />
	<meta property="og:image" content="social-image.png"/>
	<meta name="format-detection" content="telephone=no">
	
	<!-- Favicons Icon -->
	<link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.png" />
    
    <!-- Title -->
	<title>Yowl - Your Online World Link</title>
	
    <!-- Stylesheets -->
	<!-- Stylesheets -->
    <link href="/assets/vendor/lightgallery/dist/css/lightgallery.css" rel="stylesheet">
    <link href="/assets/vendor/lightgallery/dist/css/lg-thumbnail.css" rel="stylesheet">
    <link href="/assets/vendor/lightgallery/dist/css/lg-zoom.css" rel="stylesheet">	
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
	<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;300;400;600;700;800;900&amp;family=Poppins:wght@100;200;300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 30px;
        }
        .profile-info {
            flex-grow: 1;
        }
        .stats {
            display: flex;
            gap: 30px;
            margin: 20px 0;
        }
        .post-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .post-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .post-box img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        .post-info {
            padding: 15px;
        }
        .location {
            color: #666;
            font-size: 0.9em;
        }
        .stats-post {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
    </style>

</head>    
</head>   
<body class="bg-gradient-2">
<div class="page-wraper header-fixed">
    
    <!-- Preloader -->
    <div id="preloader">
        <div class="spinner"></div>
    </div>
    <!-- Preloader end-->
    
	<!-- Header -->
	<header class="header">
		<div class="container">
			<div class="main-bar">
				<div class="left-content">
					<a href="javascript:void(0);" class="back-btn">
						<i class="fa-solid fa-arrow-left"></i>
					</a>
					<h4 class="title mb-0">User Profile</h4>
				</div>
				<div class="mid-content">
				</div>
				<div class="right-content">
				</div>
			</div>
		</div>
	</header>
    <!-- Header End -->
	
    <!-- Page Content -->
    <div class="page-content">
        <div class="container profile-area">
            <div class="profile">
                <div class="main-profile">
					<div class="left-content">
						<span>@barian__23</span>
						<h5 class="mt-1">Brian Harahap</h5>
						<h6 class="text-primary font-w400">Designer</h6>
					</div>
					<div class="right-content">
						<div class="upload-box">
							<img src="/assets/images/stories/pic2.png" alt="/">
						</div>
					</div>
				</div>
                <div class="info">
					<h6>About me</h6>
					<p>...</p>
				</div>
				<ul class="list-button">
					<li>
						<a href="javascript:void(0);">Following</a>
					</li>
					<li>
						<a href="/private">Message</a>
					</li>
					<li>
						<a href="javascript:void(0);"><svg id="Layer_1" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1"><g fill="rgb(0,0,0)"><path d="m20 6a6 6 0 1 0 -6 6 6.006 6.006 0 0 0 6-6zm-10 0a4 4 0 1 1 4 4 4 4 0 0 1 -4-4z"/><path d="m17 14h-6a7.008 7.008 0 0 0 -7 7v2a1 1 0 0 0 2 0v-2a5.006 5.006 0 0 1 5-5h6a5.006 5.006 0 0 1 5 5v2a1 1 0 0 0 2 0v-2a7.008 7.008 0 0 0 -7-7z"/><path d="m4 7a1 1 0 0 0 -1 1v2h-2a1 1 0 0 0 0 2h2v2a1 1 0 0 0 2 0v-2h2a1 1 0 0 0 0-2h-2v-2a1 1 0 0 0 -1-1z"/></g></svg></a>
					</li>
				</ul>
            </div>			
            <div class="contant-section">
				<div class="social-bar">
					<ul>
						<li class="active">
							<a href="javascript:void(0);">
								<h4>0</h4>	
								<span>Post</span>
							</a>
						</li>
						<li>
							<a href="/social-friends.html">
								<h4>0</h4>	
								<span>Following</span>
							</a>
						</li>
						<li>
							<a href="/social-friends.html">
								<h4>0</h4>	
								<span>Followers</span>
							</a>
						</li>
					</ul>
				</div>
				<div class="title-bar my-2">
					<h6 class="mb-0">My Posts</h6>
					<div class="dz-tab style-2">
						<ul class="nav nav-tabs" id="myTab3" role="tablist">
						  <li class="nav-item" role="presentation">
							<button class="nav-link active" id="home-tab3" data-bs-toggle="tab" data-bs-target="#home-tab-pane3" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M10 3H3V10H10V3Z" stroke="var(--primary)" stroke-width="2" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M21 3H14V10H21V3Z" stroke="var(--primary)" stroke-width="2" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M21 14H14V21H21V14Z" stroke="var(--primary)" stroke-width="2" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M10 14H3V21H10V14Z" stroke="var(--primary)" stroke-width="2" stroke-opacity="0.5" stroke-linecap="round" stroke-linejoin="round"></path>
								</svg>
							</button>
						  </li>
						  <li class="nav-item" role="presentation">
							<button class="nav-link" id="profile-tab3" data-bs-toggle="tab" data-bs-target="#profile-tab-pane3" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false" tabindex="-1">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M8 6H21" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M8 12H21" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M8 18H21" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M3 6H3.01" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M3 12H3.01" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
									<path d="M3 18H3.01" stroke="var(--primary)" stroke-opacity="0.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
								</svg>
							</button>
						  </li>
					</ul></div>
				</div>
        <div id="lightgallery" class="post-grid"></div>
			</div>
            <p style="margin-left: 2.5em;padding: 0 0cm 2.5cm 0;border-width: 2px;"></p>
        </div>
    </div>
    <!-- Page Content End-->
    
    <!-- Menubar -->
	<div class="menubar-area">
		<div class="toolbar-inner menubar-nav">
			<a href="/" class="nav-link">
				<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" xmlns:v="https://vecta.io/nano"><path d="M21.44 11.035a.75.75 0 0 1-.69.465H18.5V19a2.25 2.25 0 0 1-2.25 2.25h-3a.75.75 0 0 1-.75-.75V16a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 1-.75.75h-3A2.25 2.25 0 0 1 3.5 19v-7.5H1.25a.75.75 0 0 1-.69-.465.75.75 0 0 1 .158-.818l9.75-9.75A.75.75 0 0 1 11 .246a.75.75 0 0 1 .533.222l9.75 9.75a.75.75 0 0 1 .158.818z" fill="#b5b5b5"/></svg>
			</a>
            <a href="/search" class="nav-link">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="#b5b5b5" stroke-opacity="1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M21 21L16.65 16.65" stroke="#b5b5b5" stroke-opacity="1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
			</a>
			 <a href="/post" class="nav-link add-post">
				<i class="fa-solid fa-plus"></i>
			</a>
			<a href="/select" class="nav-link">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#b5b5b5" viewBox="0 0 511.606 511.606" xmlns:v="https://vecta.io/nano"><path d="M436.594 74.943c-99.917-99.917-261.637-99.932-361.568 0-80.348 80.347-95.531 199.817-48.029 294.96L.662 485.742c-3.423 15.056 10.071 28.556 25.133 25.133l115.839-26.335c168.429 84.092 369.846-37.653 369.846-228.812 0-68.29-26.595-132.494-74.886-180.785zM309.143 319.394h-160c-11.598 0-21-9.402-21-21s9.402-21 21-21h160c11.598 0 21 9.402 21 21s-9.402 21-21 21zm53.334-85.333H149.143c-11.598 0-21-9.402-21-21s9.402-21 21-21h213.334c11.598 0 21 9.402 21 21s-9.403 21-21 21z"/></svg>
			</a>
			<a href="/profile" class="nav-link active">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="21" fill="#b5b5b5" xmlns:v="https://vecta.io/nano"><path d="M8 7.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 1 0 0 7.5zm7.5 9v1.5c-.002.199-.079.39-.217.532C13.61 20.455 8.57 20.5 8 20.5s-5.61-.045-7.282-1.718C.579 18.64.501 18.449.5 18.25v-1.5a7.5 7.5 0 1 1 15 0z"/></svg>
			</a>
		</div>
	</div>
	<!-- Menubar -->
</div> 
<!--**********************************
    Scripts
***********************************-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>

<script src="/assets/js/jquery.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/lightgallery/dist/lightgallery.umd.js"></script>
<script src="/assets/vendor/lightgallery/dist/plugins/thumbnail/lg-thumbnail.umd.js"></script>
<script src="/assets/vendor/lightgallery/dist/plugins/zoom/lg-zoom.umd.js"></script>
<script src="/assets/js/settings.js"></script>
<script src="/assets/js/custom.js"></script>
<script>
const SUPABASE_URL = 'https://rxacwdemlmdgkbcfpgfy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4YWN3ZGVtbG1kZ2tiY2ZwZ2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczNzk5MzUsImV4cCI6MjA1Mjk1NTkzNX0.sWK8Ku0QLPawq4abxgmF0X0v7orWD4vrmXgDn32esQk';

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('a');
    const username = getUrlParameter('username');
    
    links.forEach(link => {
        if (link.href.includes('social-friends.html')) {
            link.href = `/followers/?username=${username}`;
        }
    });
});

async function loadProfile() {
    // Check if there's a username in URL parameters
    let profileUsername = getUrlParameter('username');
    const loggedInUsername = getCookie('username');
    
    // If no username in URL, show "User not found"
    if (!profileUsername) {
        showUserNotFound();
        return;
    }

    try {
        // Fetch user data
        const userResponse = await axios.get(`${SUPABASE_URL}/rest/v1/users?username=eq.${profileUsername}`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
            }
        });

        if (userResponse.data.length > 0) {
            const user = userResponse.data[0];

            // Update profile information
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.profile > div.main-profile > div.left-content > span").textContent = `@${user.username}`;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.profile > div.main-profile > div.left-content > h5").textContent = user.name;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.profile > div.main-profile > div.left-content > h6").textContent = user.profession;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.contant-section > div.social-bar > ul > li:nth-child(3) > a > h4").textContent = user.followers_count;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.contant-section > div.social-bar > ul > li:nth-child(2) > a > h4").textContent = user.following_count;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.profile > div.info > p").textContent = user.about;
            
            // Update all profile pictures
            document.querySelectorAll('img[src="/assets/images/stories/pic2.png"]').forEach(function(img) { img.src = user.img_url; });

            // Fetch user's posts
            const postsResponse = await axios.get(`${SUPABASE_URL}/rest/v1/post?username=eq.${profileUsername}&order=created_at.desc`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });

            const posts = postsResponse.data;
            document.querySelector("body > div.page-wraper.header-fixed > div.page-content > div > div.contant-section > div.social-bar > ul > li.active > a > h4").textContent = posts.length;

            // Display posts
            const postsContainer = document.getElementById('lightgallery');
            postsContainer.innerHTML = '';

            posts.forEach(post => {
                const postHTML = `
                    <div class="post-box" id="post-${post.id}">
                        <div class="post-header">
                            <img src="${post.img_url}" alt="post image" onclick="showPostId(${post.id})">
                            ${profileUsername === loggedInUsername ? 
                              `<button class="delete-btn" onclick="deletePost(${post.id}, '${profileUsername}')">🗑️</button>` 
                              : ''}
                        </div>
                        <div class="post-info">
                            <p>${post.text}</p>
                            <span class="location">📍 ${post.localisation}</span>
                            <div class="stats-post">
                                <span>❤️ ${post.likes}</span>
                                <span>💬 ${post.comments}</span>
                            </div>
                        </div>
                    </div>
                `;
                postsContainer.insertAdjacentHTML('beforeend', postHTML);
            });

        } else {
            showUserNotFound();
        }
    } catch (error) {
        console.error('Error fetching profile:', error);
        showUserNotFound();
    }
}

function showUserNotFound() {
    // Create a styled "User not found" message
    const content = `
        <div class="user-not-found">
            <h2>User Not Found</h2>
            <p>The profile you're looking for doesn't exist.</p>
            <a href="/" class="home-link">Go to Home</a>
        </div>
    `;
    
    // Add styles for the "User not found" message
    const userNotFoundStyles = `
        .user-not-found {
            text-align: center;
            padding: 50px 20px;
            margin: 50px auto;
            max-width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .user-not-found h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .user-not-found p {
            color: #666;
            margin-bottom: 30px;
        }
        .home-link {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .home-link:hover {
            background: #0056b3;
        }
    `;

    // Add the styles to the document
    const styleSheet = document.createElement("style");
    styleSheet.textContent = userNotFoundStyles;
    document.head.appendChild(styleSheet);

    // Replace the page content with the "User not found" message
    document.querySelector('.page-content').innerHTML = content;
}
// Add styles
const style = document.createElement('style');
style.textContent = `
    .post-header {
        position: relative;
        display: inline-block;
        width: 100%;
    }
    .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 1000;
    }
    .delete-btn:hover {
        background: rgba(255, 0, 0, 0.8);
        color: white;
    }
`;
document.head.appendChild(style);

function showPostId(postId) {
    alert(`Post ID: ${postId}`);
}

// Initialize profile
loadProfile();
async function initializeFollowButton() {
    const profileUsername = getUrlParameter('username');
    const loggedInUsername = getCookie('username');
    const followButton = document.querySelector('.follow-link');

    // Don't show follow button on own profile or if not logged in
    if (!loggedInUsername || !profileUsername || profileUsername === loggedInUsername) {
        if (followButton) {
            followButton.style.display = 'none';
        }
        return;
    }

    try {
        // Check if already following
        const response = await axios.get(`${SUPABASE_URL}/rest/v1/follows`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            params: {
                follower_username: `eq.${loggedInUsername}`,
                following_username: `eq.${profileUsername}`
            }
        });

        if (response.data.length > 0) {
            followButton.textContent = 'Following';
            followButton.classList.add('light', 'badge-primary');
        } else {
            followButton.textContent = 'Follow';
            followButton.classList.remove('light', 'badge-primary');
        }
    } catch (error) {
        console.error('Error checking follow status:', error);
    }
}

async function toggleFollow() {
    const profileUsername = getUrlParameter('username');
    const loggedInUsername = getCookie('username');

    if (!loggedInUsername) {
        window.location.href = "/authentication/";
        return;
    }

    const followButton = document.querySelector('.follow-link');
    const isFollowing = followButton.textContent === 'Following';

    try {
        if (isFollowing) {
            // Unfollow
            await axios({
                method: 'DELETE',
                url: `${SUPABASE_URL}/rest/v1/follows`,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                params: {
                    follower_username: `eq.${loggedInUsername}`,
                    following_username: `eq.${profileUsername}`
                }
            });

            // Update counts
            await updateFollowCounts(profileUsername, -1);
            
            followButton.textContent = 'Follow';
            followButton.classList.remove('light', 'badge-primary');
        } else {
            // Follow
            await axios({
                method: 'POST',
                url: `${SUPABASE_URL}/rest/v1/follows`,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                },
                data: {
                    follower_username: loggedInUsername,
                    following_username: profileUsername
                }
            });

            // Update counts
            await updateFollowCounts(profileUsername, 1);
            
            followButton.textContent = 'Following';
            followButton.classList.add('light', 'badge-primary');
        }

        // Refresh the followers count display
        await loadProfile();
    } catch (error) {
        console.error('Error toggling follow:', error);
        alert('Error updating follow status. Please try again.');
    }
}
async function updateFollowCounts(username, change) {
    try {
        // Get current user data
        const userResponse = await axios.get(`${SUPABASE_URL}/rest/v1/users?username=eq.${username}`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            }
        });

        const userData = userResponse.data[0];
        const newFollowersCount = userData.followers_count + change;

        // Update followers count
        await axios({
            method: 'PATCH',
            url: `${SUPABASE_URL}/rest/v1/users`,
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            params: {
                username: `eq.${username}`
            },
            data: {
                followers_count: newFollowersCount
            }
        });

        // Update following count for the logged-in user
        const loggedInUsername = getCookie('username');
        await axios({
            method: 'PATCH',
            url: `${SUPABASE_URL}/rest/v1/users`,
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            params: {
                username: `eq.${loggedInUsername}`
            },
            data: {
                following_count: userData.following_count + change
            }
        });
    } catch (error) {
        console.error('Error updating follow counts:', error);
    }
}

// Modify your HTML link
document.querySelector('li a[href="javascript:void(0);"]').outerHTML = `
    <a href="javascript:void(0);" onclick="toggleFollow()" class="follow-link">Follow</a>
`;

// Initialize follow button state when loading profile
loadProfile().then(() => {
    initializeFollowButton();
});

</script>
</html>